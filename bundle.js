(()=>{"use strict";window.utility={isEnterEvent:(e,t)=>{"Enter"===e.key&&t()},isEscapeEvent:(e,t)=>{"Escape"===e.key&&t()},isMainMouseEvent:(e,t)=>{0===e.button&&t()},StatusCode:{OK:200,BAD_REQUEST:400,NOT_FOUND:404},ServerRequest:{GET:{method:"GET",url:"https://21.javascript.pages.academy/keksobooking/data"},POST:{method:"POST",url:"https://21.javascript.pages.academy/keksobooking"}}},window.error={showError:function(e){!function(e){const t=document.createElement("div");t.setAttribute("style",'width: 80%; height: 200px; background-color: rgba(240, 240, 234, 0.8); font-family: "Roboto", "Arial", sans-serif; position: absolute; top: 20%; left: 50%; z-index: 9999; transform: translateX(-50%); text-align: center;'),t.innerHTML='<h1 style="margin-bottom: 10px;">Error: '+e+'</h1><br><a href="index.html" style="font-size: 50px; margin:0; color: rgba(255, 86, 53, 0.7);">Обновите страницу!</a>',document.body.prepend(t)}(e)}},(()=>{const{OK:e,BAD_REQUEST:t,NOT_FOUND:o}=window.utility.StatusCode,{method:n,url:r}=window.utility.ServerRequest.GET;window.load={getData:(s,a)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let n;switch(i.status){case e:s(i.response);break;case t:n="Неверный запрос";break;case o:n="Ничего не найдено";break;default:n="Cтатус ответа: : "+i.status+" "+i.statusText}n&&a(n)})),i.addEventListener("error",(()=>{a("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{a("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=1e4,i.open(n,r),i.send()}}})(),(()=>{const e=document.querySelector("main"),{method:t,url:o}=window.utility.ServerRequest.POST,n=t=>{const o=document.querySelector("#"+t).content.querySelector("."+t).cloneNode(!0),n=()=>{o.remove()};o.addEventListener("click",n);const r=e=>{window.utility.isEscapeEvent(e,n),window.removeEventListener("keydown",r)};if(window.addEventListener("keydown",r),"error"===t){const e=o.querySelector(".error__button"),t=()=>{n(),e.removeEventListener("click",t)};e.addEventListener("click",t),window.map.removeExistPin()}e.prepend(o)};window.upload={uploadData:(e,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{const e=s.status===window.utility.StatusCode.OK;e&&r(),n(e?"success":"error")})),s.addEventListener("error",(()=>{n("error")})),s.open(t,o),s.send(e)}}})(),(()=>{let e;window.debounce={setDebounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e=["palace","flat","house","bungalow"],t=["12:00","13:00","14:00"],o=["wifi","dishwasher","parking","washer","elevator","conditioner"],n=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],r=e=>{const t=e.length-1;return Math.round(Math.random()*t)},s=e=>e[r(e)],a=(e,t)=>Math.round(Math.random()*(t-e)+e),i=e=>{let t=[];const o=r(e);for(let n=0;n<=o;n++)t.push(e[n]);return t};window.data={createPins:(r=8)=>{let c=[];const d=((e=8)=>{let t=[];const o=((e,t=1)=>{let o=[];for(;o.length<e;){const n=Math.round(Math.random()*e);if(o.includes(n)||0===n||o.push(n),Math.random()>t)return o}return o})(e);for(let n=0;n<e;n++)t.push("img/avatars/user0"+o[n]+".png");return t})();for(let u=0;u<r;u++){const r=a(0,1200),l=a(130,630);c.push({author:{avatar:d[u]},offer:{title:"Тестовая строка заголовка "+u,address:r+", "+l,price:a(500,5e5),type:s(e),rooms:a(1,5),guests:a(1,10),checkin:s(t),checkout:s(t),features:i(o),description:"Тестовое описание "+u,photos:i(n)},location:{x:r,y:l}})}return c}}})(),(()=>{const e="map__pin--main",t=document.createDocumentFragment(),o=document.querySelector(".map"),n=o.querySelector(".map__filters-container"),r=document.querySelector("#pin").content.querySelector(".map__pin"),s=document.querySelector(".map__pins"),a=document.createDocumentFragment(),i=o.querySelectorAll(".map__filter");let c,d=[];const u=e=>{const t=r.cloneNode(!0),o=t.querySelector("img"),n=e.location.x-25,s=e.location.y-70;return t.setAttribute("style","left: "+n+"px; top: "+s+"px;"),o.setAttribute("src",e.author.avatar),o.setAttribute("alt",e.offer.title),t},l=()=>{const e=o.querySelector(".map__card");if(e){const t=o.querySelector(".map__pin--active");e.remove(),t.classList.remove("map__pin--active")}},p=e=>{window.utility.isEscapeEvent(e,(()=>{l(),document.removeEventListener("keydown",p)}))},m=()=>{const t=o.querySelectorAll(".map__pin");for(let o=t.length-1;o>0;o--)t[o].classList.contains(e)||t[o].remove()},y=r=>{const i=r.length>5?5:r.length;for(let e=0;e<i;e++)a.appendChild(u(r[e]));s.appendChild(a),(r=>{const s=o.querySelectorAll(".map__pin");let a=0;for(let i=0;i<s.length;i++)if(s[i].classList.contains(e))a++;else{const e=r[i-a];s[i].addEventListener("click",(()=>{var r;r=e,l(),t.appendChild(window.card.fillCards(r)),o.insertBefore(t,n),o.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{l()})),document.addEventListener("keydown",p),s[i].classList.add("map__pin--active")}))}})(r)},v=e=>{"any"!==e&&(c=c.filter((t=>t.offer.type===e)))},w=e=>{"any"!==e&&(c=c.filter((t=>"low"===e?t.offer.price<1e4:"high"===e?t.offer.price>5e4:t.offer.price>=1e4&&t.offer.price<=5e4)))},f=e=>{"any"!==e&&(c=c.filter((t=>t.offer.rooms===+e)))},h=e=>{"any"!==e&&(c=c.filter((t=>t.offer.guests===+e)))};window.map={renderPins:y,removeExistPin:l,removePins:m,saveServerData:e=>{o.classList.remove("map--faded"),d=e,y(e)},applyFilter:()=>{c=d,l(),m();for(let e=0;e<i.length;e++){const{name:t,value:o}=i[e];switch(t){case"housing-type":v(o);break;case"housing-price":w(o);break;case"housing-rooms":f(o);break;case"housing-guests":h(o)}}(()=>{const e=o.querySelectorAll(".map__checkbox:checked");for(let t=0;t<e.length;t++)c=c.filter((o=>o.offer.features.includes(e[t].value)))})(),y(c)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=(e,t)=>{const o=e.cloneNode(!0);return o.setAttribute("src",t),o};window.card={fillCards:o=>{return document.cardElement=e.cloneNode(!0),document.cardElement.querySelector(".popup__avatar").setAttribute("src",o.author.avatar),n=o.offer,document.cardElement.querySelector(".popup__title").textContent=n.title,document.cardElement.querySelector(".popup__text--address").textContent=n.address,document.cardElement.querySelector(".popup__text--price").textContent=n.price+"₽/ночь",document.cardElement.querySelector(".popup__type").textContent={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}[n.type],document.cardElement.querySelector(".popup__text--capacity").textContent=n.rooms+" комнаты для "+n.guests+" гостей",document.cardElement.querySelector(".popup__text--time").textContent="Заезд после "+n.checkin+", выезд до "+n.checkout,document.cardElement.querySelector(".popup__description").textContent=n.description,(e=>{const t=document.cardElement.querySelector(".popup__features").children;for(let o=t.length-1;o>=0;o--){const n=t[o];let r=!1;for(let t=0;t<e.length;t++)n.classList.contains("popup__feature--"+e[t])&&(r=!0);!1===r&&n.remove()}})(o.offer.features),(e=>{const o=document.cardElement.querySelector(".popup__photos").querySelector("img");if(e.length>0){const n=document.cardElement.querySelector(".popup__photos"),r=document.createDocumentFragment();document.cardElement.querySelector(".popup__photos").querySelector("img").setAttribute("src",e[0]);for(let n=1;n<e.length;n++)r.appendChild(t(o,e[n]));n.appendChild(r)}else document.cardElement.querySelector(".popup__photos").querySelector("img").remove()})(o.offer.photos),document.cardElement;var n}}})(),(()=>{const e=document.querySelector(".map__pin--main");window.pin={movePin:()=>{e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();const n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const s=e.offsetLeft-n,a=e.offsetTop-r;var i;e.style.left=(e=>{const t=1167.5;return e>t?t:e<-32.5?-32.5:e})(s)+"px",e.style.top=((i=a)>630?630:i<65?65:i)+"px",window.page.getAddress(e.offsetLeft,e.offsetTop)},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),o=e.querySelector("#address"),n=document.querySelector(".map__pin--main"),r=e.querySelector("#type"),s=e.querySelector("#price"),a=e.querySelector("#timein"),i=e.querySelector("#timeout"),c=e.querySelector(".ad-form__submit"),d=e.querySelector("#capacity"),u=e.querySelector("#room_number"),l=document.querySelector(".map__filters"),p={PALACE:1e4,FLAT:1e3,HOUSE:5e3,BUNGALOW:0};l.addEventListener("change",(()=>{window.debounce.setDebounce(window.map.applyFilter)}));const m=e=>{for(let t=0;t<e.length;t++)e[t].toggleAttribute("disabled")},y=()=>{s.setAttribute("min",p[r.value.toUpperCase()]),s.setAttribute("placeholder",p[r.value.toUpperCase()])},v=()=>{n.style.left="570px",n.style.top="375px",e.classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),window.map.removeExistPin(),window.map.removePins(),l.reset(),q()},w=()=>{e.classList.remove("ad-form--disabled"),m(t),window.load.getData(window.map.saveServerData,window.error.showError),r.addEventListener("input",y),a.addEventListener("input",(()=>{i.value=a.value})),i.addEventListener("input",(()=>{a.value=i.value}))},f=e=>{window.utility.isEnterEvent(e,w)},h=e=>{window.utility.isMainMouseEvent(e,w)},E=()=>{n.removeEventListener("mousedown",h),n.removeEventListener("keydown",f),n.removeEventListener("mousedown",g)},_=e=>{window.utility.isEnterEvent(e,E)},g=e=>{window.utility.isMainMouseEvent(e,E)},S=()=>{const e=+u.value,t=+d.value;return(100===e?0===t:e>t&&0!==t||e===t)?d.setCustomValidity(""):d.setCustomValidity("Число гостей не соответсвует числу комнат!")};d.addEventListener("input",S),u.addEventListener("input",S),e.addEventListener("submit",(t=>{S(),d.reportValidity()&&window.upload.uploadData(new FormData(e),(()=>{c.focus(),e.reset(),c.blur()})),t.preventDefault()})),e.addEventListener("reset",(()=>{setTimeout(v,100)}));const q=()=>{o.value=Math.round(602.5)+", "+Math.round(407.5),m(t),n.addEventListener("mousedown",h),n.addEventListener("keydown",f),n.addEventListener("mousedown",g),n.addEventListener("keydown",_),y()};window.page={getAddress:(e,t)=>{const n=e+32.5,r=t+87;o.value=Math.round(n)+", "+Math.round(r)},blockPage:q}})(),window.pin.movePin(),window.page.blockPage()})();