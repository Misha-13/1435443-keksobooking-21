(()=>{"use strict";window.utility={setEnterEvent:(e,t)=>{"Enter"===e.key&&t()},setEscapeEvent:(e,t)=>{"Escape"===e.key&&t()},setMainMouseEvent:(e,t)=>{0===e.button&&t()},StatusCode:{OK:200,BAD_REQUEST:400,NOT_FOUND:404},ServerRequest:{GET:{method:"GET",url:"https://21.javascript.pages.academy/keksobooking/data"},POST:{method:"POST",url:"https://21.javascript.pages.academy/keksobooking"}}},window.error={show:e=>{(e=>{const t=document.createElement("div");t.setAttribute("style",'width: 80%; height: 200px; background-color: rgba(240, 240, 234, 0.8); font-family: "Roboto", "Arial", sans-serif; position: absolute; top: 20%; left: 50%; z-index: 9999; transform: translateX(-50%); text-align: center;'),t.innerHTML='<h1 style="margin-bottom: 10px;">Error: '+e+'</h1><br><a href="index.html" style="font-size: 50px; margin:0; color: rgba(255, 86, 53, 0.7);">Обновите страницу!</a>',document.body.prepend(t)})(e)}},(()=>{const{OK:e,BAD_REQUEST:t,NOT_FOUND:o}=window.utility.StatusCode,{method:r,url:n}=window.utility.ServerRequest.GET;window.load={getData:(s,i)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{let r;switch(a.status){case e:s(a.response);break;case t:r="Неверный запрос";break;case o:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+a.status+" "+a.statusText}r&&i(r)})),a.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{i("Запрос не успел выполниться за "+a.timeout+"мс")})),a.timeout=1e4,a.open(r,n),a.send()}}})(),(()=>{const e=document.querySelector("main"),{method:t,url:o}=window.utility.ServerRequest.POST,r=t=>{const o=document.querySelector("#"+t).content.querySelector("."+t).cloneNode(!0),r=()=>{o.remove()};o.addEventListener("click",r);const n=e=>{window.utility.setEscapeEvent(e,r),window.removeEventListener("keydown",n)};if(window.addEventListener("keydown",n),"error"===t){const e=o.querySelector(".error__button"),t=()=>{r(),e.removeEventListener("click",t)};e.addEventListener("click",t),window.map.removeExistPin()}e.prepend(o)};window.upload={post:(e,n)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{const e=s.status===window.utility.StatusCode.OK;e&&n(),r(e?"success":"error")})),s.addEventListener("error",(()=>{r("error")})),s.open(t,o),s.send(e)}}})(),(()=>{let e;window.debounce={set:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.preview={show:(t,o)=>{t.addEventListener("change",(()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;let t=o.querySelector("img");if(!t){const e=(()=>{const e=document.createElement("img");return e.setAttribute("width","40"),e.setAttribute("height","44"),e.setAttribute("alt","Фотография жилья"),e})();o.setAttribute("style","display:flex; align-items:center; justify-content:space-around;"),o.prepend(e),t=o.querySelector("img")}e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(r)}}))},remove:e=>{const t=document.querySelector(".ad-form-header__preview");let o=e.querySelector("img");e===t?(o=t.querySelector("img"),o.src="img/muffin-grey.svg"):o&&(e.removeAttribute("style"),o.remove())}}})(),(()=>{const e="map__pin--main",t=document.createDocumentFragment(),o=document.querySelector(".map"),r=o.querySelector(".map__filters-container"),n=document.querySelector("#pin").content.querySelector(".map__pin"),s=document.querySelector(".map__pins"),i=document.createDocumentFragment(),a=Array.from(o.querySelectorAll(".map__filter"));let c,d=[];const u=e=>{const t=n.cloneNode(!0),o=t.querySelector("img"),r=e.location.x-25,s=e.location.y-70;return t.setAttribute("style","left: "+r+"px; top: "+s+"px;"),o.setAttribute("src",e.author.avatar),o.setAttribute("alt",e.offer.title),t},l=()=>{const e=o.querySelector(".map__card");if(e){const t=o.querySelector(".map__pin--active");e.remove(),t.classList.remove("map__pin--active")}},p=e=>{window.utility.setEscapeEvent(e,(()=>{l(),document.removeEventListener("keydown",p)}))},m=()=>{Array.from(o.querySelectorAll(".map__pin")).forEach((t=>{t.classList.contains(e)||t.remove()}))},v=n=>{const a=n.length>5?5:n.length;for(let e=0;e<a;e++)n[e].offer&&i.appendChild(u(n[e]));s.appendChild(i),(n=>{const s=Array.from(o.querySelectorAll(".map__pin"));let i=0;s.forEach(((s,a)=>{if(s.classList.contains(e))i++;else{const e=n[a-i];s.addEventListener("click",(()=>{var n;n=e,l(),t.appendChild(window.card.fillCards(n)),o.insertBefore(t,r),o.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{l()})),document.addEventListener("keydown",p),s.classList.add("map__pin--active")}))}}))})(n)},y=(e,t)=>{"any"!==e&&(c=c.filter((o=>o.offer[t]===(isNaN(e)?e:+e))))};window.map={renderPins:v,removeExistPin:l,removePins:m,saveServerData:e=>{o.classList.remove("map--faded"),d=e,v(e)},applyFilter:()=>{c=d,l(),m(),a.forEach((e=>{const{name:t,value:o}=e;switch(t){case"housing-type":y(o,"type");break;case"housing-price":(e=>{"any"!==e&&(c=c.filter((t=>"low"===e?t.offer.price<1e4:"high"===e?t.offer.price>5e4:t.offer.price>=1e4&&t.offer.price<=5e4)))})(o);break;case"housing-rooms":y(o,"rooms");break;case"housing-guests":y(o,"guests")}})),Array.from(o.querySelectorAll(".map__checkbox:checked")).forEach((e=>{c=c.filter((t=>t.offer.features.includes(e.value)))})),v(c)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e,t)=>{const o=e.cloneNode(!0);return o.src=t,o},r=(e,t,o)=>{const r=document.card.querySelector(t);e?r.textContent=o:r.remove()},n=(e,t,o,r,n)=>{const s=document.card.querySelector(n);return e&&o?((e,t,o)=>{e.textContent=t+o})(s,t,r):e||o?((e,t,o,r)=>{e.textContent=t?o:r})(s,e,t,r):s.remove()};window.card={fillCards:s=>(document.card=e.cloneNode(!0),document.card.querySelector(".popup__avatar").setAttribute("src",s.author.avatar),(({title:e,address:o,price:s,type:i,rooms:a,guests:c,checkin:d,checkout:u,description:l})=>{r(e,".popup__title",e),r(o,".popup__text--address",o),r(s,".popup__text--price",s+" ₽/ночь"),r(i,".popup__type",t[i]),n(a,a+" комнаты(-а) ",c,` для ${c}  гостей(-я)`,".popup__text--capacity"),n(d,"Заезд после "+d,u," выезд до "+u,".popup__text--time"),r(l,".popup__description",l)})(s.offer),(e=>{const t=document.card.querySelector(".popup__features");if(e&&e.length>0){const t=document.card.querySelector(".popup__features").children;Array.from(t).forEach((t=>{let o=!1;for(let r=0;r<e.length;r++)if(t.classList.contains("popup__feature--"+e[r])){o=!0;break}o||t.remove()}))}else t.remove()})(s.offer.features),(e=>{const t=document.card.querySelector(".popup__photos").querySelector("img");if(e&&e.length>0){const r=document.card.querySelector(".popup__photos"),n=document.createDocumentFragment();document.card.querySelector(".popup__photos").querySelector("img").setAttribute("src",e[0]);for(let r=1;r<e.length;r++)n.appendChild(o(t,e[r]));r.appendChild(n)}else document.card.querySelector(".popup__photos").remove()})(s.offer.photos),document.card)}})(),(()=>{const e=1167.5,t=document.querySelector(".map__pin--main");window.pin={move:()=>{t.addEventListener("mousedown",(o=>{o.preventDefault();let r={x:o.clientX,y:o.clientY};const n=o=>{o.preventDefault();const n=r.x-o.clientX,s=r.y-o.clientY;r={x:o.clientX,y:o.clientY};const i=t.offsetLeft-n,a=t.offsetTop-s;var c,d;t.style.left=((c=i)>e?e:c<-32.5?-32.5:c)+"px",t.style.top=((d=a)>543?543:d<43?43:d)+"px",window.page.getAddress(t.offsetLeft,t.offsetTop)},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=Array.from(e.querySelectorAll("fieldset")),o=e.querySelector("#address"),r=document.querySelector(".map__pin--main"),n=e.querySelector("#type"),s=e.querySelector("#price"),i=e.querySelector("#timein"),a=e.querySelector("#timeout"),c=e.querySelector(".ad-form__submit"),d=e.querySelector("#capacity"),u=e.querySelector("#room_number"),l=document.querySelector(".map__filters"),p=Array.from(l.children),m=document.querySelector(".ad-form__input"),v=document.querySelector(".ad-form__photo"),y=document.querySelector(".ad-form-header__input"),w=document.querySelector(".ad-form-header__preview"),f={PALACE:1e4,FLAT:1e3,HOUSE:5e3,BUNGALOW:0};window.preview.show(y,w),window.preview.show(m,v),l.addEventListener("change",(()=>{window.debounce.set(window.map.applyFilter)}));const _=e=>{e.forEach((e=>{e.toggleAttribute("disabled")}))},E=(e,t)=>{const r=e+32.5,n=t+87;o.value=Math.round(r)+", "+Math.round(n)},h=()=>{s.setAttribute("min",f[n.value.toUpperCase()]),s.setAttribute("placeholder",f[n.value.toUpperCase()])},S=()=>{r.style.left="570px",r.style.top="375px",e.classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),window.map.removeExistPin(),window.map.removePins(),window.preview.remove(w),window.preview.remove(v),l.reset(),C()},q=()=>{e.classList.remove("ad-form--disabled"),E(570,375),_(t),_(p),window.load.getData(window.map.saveServerData,window.error.show),n.addEventListener("input",h),i.addEventListener("input",(()=>{a.value=i.value})),a.addEventListener("input",(()=>{i.value=a.value}))},g=e=>{window.utility.setEnterEvent(e,q)},L=e=>{window.utility.setMainMouseEvent(e,q)},b=()=>{r.removeEventListener("mousedown",L),r.removeEventListener("keydown",g),r.removeEventListener("mousedown",k)},A=e=>{window.utility.setEnterEvent(e,b)},k=e=>{window.utility.setMainMouseEvent(e,b)},x=()=>{const e=+u.value,t=+d.value;return(100===e?0===t:e>t&&0!==t||e===t)?d.setCustomValidity(""):d.setCustomValidity("Число гостей не соответсвует числу комнат!")};d.addEventListener("input",x),u.addEventListener("input",x),e.addEventListener("submit",(t=>{x(),d.reportValidity()&&window.upload.post(new FormData(e),(()=>{c.focus(),e.reset(),c.blur()})),t.preventDefault()})),e.addEventListener("reset",(()=>{setTimeout(S,100)}));const C=()=>{o.value=Math.round(602.5)+", "+Math.round(407.5),_(t),_(p),r.addEventListener("mousedown",L),r.addEventListener("keydown",g),r.addEventListener("mousedown",k),r.addEventListener("keydown",A),h()};window.page={getAddress:E,block:C}})(),window.pin.move(),window.page.block()})();