(()=>{"use strict";window.utility={setEnterEvent:(e,t)=>{"Enter"===e.key&&t()},setEscapeEvent:(e,t)=>{"Escape"===e.key&&t()},setMainMouseEvent:(e,t)=>{0===e.button&&t()},StatusCode:{OK:200,BAD_REQUEST:400,NOT_FOUND:404},ServerRequest:{GET:{method:"GET",url:"https://21.javascript.pages.academy/keksobooking/data"},POST:{method:"POST",url:"https://21.javascript.pages.academy/keksobooking"}}},window.error={showError:function(e){!function(e){const t=document.createElement("div");t.setAttribute("style",'width: 80%; height: 200px; background-color: rgba(240, 240, 234, 0.8); font-family: "Roboto", "Arial", sans-serif; position: absolute; top: 20%; left: 50%; z-index: 9999; transform: translateX(-50%); text-align: center;'),t.innerHTML='<h1 style="margin-bottom: 10px;">Error: '+e+'</h1><br><a href="index.html" style="font-size: 50px; margin:0; color: rgba(255, 86, 53, 0.7);">Обновите страницу!</a>',document.body.prepend(t)}(e)}},(()=>{const{OK:e,BAD_REQUEST:t,NOT_FOUND:o}=window.utility.StatusCode,{method:r,url:n}=window.utility.ServerRequest.GET;window.load={getData:(s,a)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let r;switch(i.status){case e:s(i.response);break;case t:r="Неверный запрос";break;case o:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+i.status+" "+i.statusText}r&&a(r)})),i.addEventListener("error",(()=>{a("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{a("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=1e4,i.open(r,n),i.send()}}})(),(()=>{const e=document.querySelector("main"),{method:t,url:o}=window.utility.ServerRequest.POST,r=t=>{const o=document.querySelector("#"+t).content.querySelector("."+t).cloneNode(!0),r=()=>{o.remove()};o.addEventListener("click",r);const n=e=>{window.utility.setEscapeEvent(e,r),window.removeEventListener("keydown",n)};if(window.addEventListener("keydown",n),"error"===t){const e=o.querySelector(".error__button"),t=()=>{r(),e.removeEventListener("click",t)};e.addEventListener("click",t),window.map.removeExistPin()}e.prepend(o)};window.upload={uploadData:(e,n)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{const e=s.status===window.utility.StatusCode.OK;e&&n(),r(e?"success":"error")})),s.addEventListener("error",(()=>{r("error")})),s.open(t,o),s.send(e)}}})(),(()=>{let e;window.debounce={setDebounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.preview={showPreview:(t,o)=>{t.addEventListener("change",(()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;let t=o.querySelector("img");if(!t){const e=(()=>{const e=document.createElement("img");return e.setAttribute("width","40"),e.setAttribute("height","44"),e.setAttribute("alt","Фотография жилья"),e})();o.setAttribute("style","display:flex; align-items:center; justify-content:space-around;"),o.prepend(e),t=o.querySelector("img")}e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(r)}}))},removePreview:e=>{const t=document.querySelector(".ad-form-header__preview");let o=e.querySelector("img");e===t?(o=t.querySelector("img"),o.src="img/muffin-grey.svg"):o&&(e.removeAttribute("style"),o.remove())}}})(),(()=>{const e=["palace","flat","house","bungalow"],t=["12:00","13:00","14:00"],o=["wifi","dishwasher","parking","washer","elevator","conditioner"],r=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],n=e=>{const t=e.length-1;return Math.round(Math.random()*t)},s=e=>e[n(e)],a=(e,t)=>Math.round(Math.random()*(t-e)+e),i=e=>{let t=[];const o=n(e);for(let r=0;r<=o;r++)t.push(e[r]);return t};window.data={createPins:(n=8)=>{let c=[];const d=((e=8)=>{let t=[];const o=((e,t=1)=>{let o=[];for(;o.length<e;){const r=Math.round(Math.random()*e);if(o.includes(r)||0===r||o.push(r),Math.random()>t)return o}return o})(e);for(let r=0;r<e;r++)t.push("img/avatars/user0"+o[r]+".png");return t})();for(let u=0;u<n;u++){const n=a(0,1200),l=a(130,630);c.push({author:{avatar:d[u]},offer:{title:"Тестовая строка заголовка "+u,address:n+", "+l,price:a(500,5e5),type:s(e),rooms:a(1,5),guests:a(1,10),checkin:s(t),checkout:s(t),features:i(o),description:"Тестовое описание "+u,photos:i(r)},location:{x:n,y:l}})}return c}}})(),(()=>{const e="map__pin--main",t=document.createDocumentFragment(),o=document.querySelector(".map"),r=o.querySelector(".map__filters-container"),n=document.querySelector("#pin").content.querySelector(".map__pin"),s=document.querySelector(".map__pins"),a=document.createDocumentFragment(),i=Array.from(o.querySelectorAll(".map__filter"));let c,d=[];const u=e=>{const t=n.cloneNode(!0),o=t.querySelector("img"),r=e.location.x-25,s=e.location.y-70;return t.setAttribute("style","left: "+r+"px; top: "+s+"px;"),o.setAttribute("src",e.author.avatar),o.setAttribute("alt",e.offer.title),t},l=()=>{const e=o.querySelector(".map__card");if(e){const t=o.querySelector(".map__pin--active");e.remove(),t.classList.remove("map__pin--active")}},p=e=>{window.utility.setEscapeEvent(e,(()=>{l(),document.removeEventListener("keydown",p)}))},m=()=>{Array.from(o.querySelectorAll(".map__pin")).forEach((t=>{t.classList.contains(e)||t.remove()}))},v=n=>{const i=n.length>5?5:n.length;for(let e=0;e<i;e++)n[e].offer&&a.appendChild(u(n[e]));s.appendChild(a),(n=>{const s=Array.from(o.querySelectorAll(".map__pin"));let a=0;s.forEach(((s,i)=>{if(s.classList.contains(e))a++;else{const e=n[i-a];s.addEventListener("click",(()=>{var n;n=e,l(),t.appendChild(window.card.fillCards(n)),o.insertBefore(t,r),o.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",(()=>{l()})),document.addEventListener("keydown",p),s.classList.add("map__pin--active")}))}}))})(n)};window.map={renderPins:v,removeExistPin:l,removePins:m,saveServerData:e=>{o.classList.remove("map--faded"),d=e,v(e)},applyFilter:()=>{c=d,l(),m(),i.forEach((e=>{const{name:t,value:o}=e;switch(t){case"housing-type":(e=>{"any"!==e&&(c=c.filter((t=>t.offer.type===e)))})(o);break;case"housing-price":(e=>{"any"!==e&&(c=c.filter((t=>"low"===e?t.offer.price<1e4:"high"===e?t.offer.price>5e4:t.offer.price>=1e4&&t.offer.price<=5e4)))})(o);break;case"housing-rooms":(e=>{"any"!==e&&(c=c.filter((t=>t.offer.rooms===+e)))})(o);break;case"housing-guests":(e=>{"any"!==e&&(c=c.filter((t=>t.offer.guests===+e)))})(o)}})),Array.from(o.querySelectorAll(".map__checkbox:checked")).forEach((e=>{c=c.filter((t=>t.offer.features.includes(e.value)))})),v(c)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e,t)=>{const o=e.cloneNode(!0);return o.setAttribute("src",t),o};window.card={fillCards:r=>{return document.cardElement=e.cloneNode(!0),document.cardElement.querySelector(".popup__avatar").setAttribute("src",r.author.avatar),(e=>{const t=document.cardElement.querySelector(".popup__title");e?t.textContent=e:t.remove()})((n=r.offer).title),(e=>{const t=document.cardElement.querySelector(".popup__text--address");e?t.textContent=e:t.remove()})(n.address),(e=>{const t=document.cardElement.querySelector(".popup__text--price");e?t.textContent=e+"₽/ночь":t.remove()})(n.price),(e=>{const o=document.cardElement.querySelector(".popup__type");e?o.textContent=t[e]:o.remove()})(n.type),((e,t)=>{const o=document.cardElement.querySelector(".popup__text--capacity");e||t?o.textContent=e+" комнаты для "+t+" гостей":o.remove()})(n.rooms,n.guests),((e,t)=>{const o=document.cardElement.querySelector(".popup__text--time");e||t?o.textContent="Заезд после "+e+", выезд до "+t:o.remove()})(n.checkin,n.checkout),(e=>{const t=document.cardElement.querySelector(".popup__description");e?t.textContent=e:t.remove()})(n.description),(e=>{const t=document.cardElement.querySelector(".popup__features"),o=document.cardElement.querySelector(".popup__features").children,r=Array.from(o);e.length>0?r.forEach((t=>{let o=!1;for(let r=0;r<e.length;r++)if(t.classList.contains("popup__feature--"+e[r])){o=!0;break}o||t.remove()})):t.remove()})(r.offer.features),(e=>{const t=document.cardElement.querySelector(".popup__photos").querySelector("img");if(e.length>0){const r=document.cardElement.querySelector(".popup__photos"),n=document.createDocumentFragment();document.cardElement.querySelector(".popup__photos").querySelector("img").setAttribute("src",e[0]);for(let r=1;r<e.length;r++)n.appendChild(o(t,e[r]));r.appendChild(n)}else document.cardElement.querySelector(".popup__photos").remove()})(r.offer.photos),document.cardElement;var n}}})(),(()=>{const e=document.querySelector(".map__pin--main");window.pin={movePin:()=>{e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault();const r=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const s=e.offsetLeft-r,a=e.offsetTop-n;var i;e.style.left=(e=>{const t=1167.5;return e>t?t:e<-32.5?-32.5:e})(s)+"px",e.style.top=((i=a)>543?543:i<43?43:i)+"px",window.page.getAddress(e.offsetLeft,e.offsetTop)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=Array.from(e.querySelectorAll("fieldset")),o=e.querySelector("#address"),r=document.querySelector(".map__pin--main"),n=e.querySelector("#type"),s=e.querySelector("#price"),a=e.querySelector("#timein"),i=e.querySelector("#timeout"),c=e.querySelector(".ad-form__submit"),d=e.querySelector("#capacity"),u=e.querySelector("#room_number"),l=document.querySelector(".map__filters"),p=Array.from(l.children),m=document.querySelector(".ad-form__input"),v=document.querySelector(".ad-form__photo"),y=document.querySelector(".ad-form-header__input"),w=document.querySelector(".ad-form-header__preview"),f={PALACE:1e4,FLAT:1e3,HOUSE:5e3,BUNGALOW:0};window.preview.showPreview(y,w),window.preview.showPreview(m,v),l.addEventListener("change",(()=>{window.debounce.setDebounce(window.map.applyFilter)}));const h=e=>{e.forEach((e=>{e.toggleAttribute("disabled")}))},E=(e,t)=>{const r=e+32.5,n=t+87;o.value=Math.round(r)+", "+Math.round(n)},_=()=>{s.setAttribute("min",f[n.value.toUpperCase()]),s.setAttribute("placeholder",f[n.value.toUpperCase()])},g=()=>{r.style.left="570px",r.style.top="375px",e.classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),window.map.removeExistPin(),window.map.removePins(),window.preview.removePreview(w),window.preview.removePreview(v),l.reset(),C()},S=()=>{e.classList.remove("ad-form--disabled"),E(570,375),h(t),h(p),window.load.getData(window.map.saveServerData,window.error.showError),n.addEventListener("input",_),a.addEventListener("input",(()=>{i.value=a.value})),i.addEventListener("input",(()=>{a.value=i.value}))},q=e=>{window.utility.setEnterEvent(e,S)},L=e=>{window.utility.setMainMouseEvent(e,S)},b=()=>{r.removeEventListener("mousedown",L),r.removeEventListener("keydown",q),r.removeEventListener("mousedown",A)},k=e=>{window.utility.setEnterEvent(e,b)},A=e=>{window.utility.setMainMouseEvent(e,b)},x=()=>{const e=+u.value,t=+d.value;return(100===e?0===t:e>t&&0!==t||e===t)?d.setCustomValidity(""):d.setCustomValidity("Число гостей не соответсвует числу комнат!")};d.addEventListener("input",x),u.addEventListener("input",x),e.addEventListener("submit",(t=>{x(),d.reportValidity()&&window.upload.uploadData(new FormData(e),(()=>{c.focus(),e.reset(),c.blur()})),t.preventDefault()})),e.addEventListener("reset",(()=>{setTimeout(g,100)}));const C=()=>{o.value=Math.round(602.5)+", "+Math.round(407.5),h(t),h(p),r.addEventListener("mousedown",L),r.addEventListener("keydown",q),r.addEventListener("mousedown",A),r.addEventListener("keydown",k),_()};window.page={getAddress:E,blockPage:C}})(),window.pin.movePin(),window.page.blockPage()})();